<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dealer Dashboard | Ionvex Energy Solutions</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- GLOBAL CSS -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/dealer.css" />
</head>
<body>

<!-- ðŸ” AUTH + ROLE GUARD -->
<script type="module">
  import { auth } from "/js/firebase/auth.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getUserRole } from "/js/firebase/role.js";

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/public/login.html";
      return;
    }

    const role = await getUserRole(user.uid);
    if (role !== "DEALER") {
      window.location.href = "/public/login.html";
    }
  });
</script>

<!-- ================= HEADER ================= -->
<header class="dealer-header">
  <h2>Ionvex Dealer Panel</h2>
  <button id="logoutBtn" class="btn-outline">Logout</button>
</header>

<!-- ================= MAIN ================= -->
<main class="dealer-main">

  <h1>Welcome, Dealer ðŸ‘‹</h1>

  <!-- STATS -->
  <section class="dealer-cards">

    <div class="card">
      <h3>Activated Batteries</h3>
      <span id="totalActivated">0</span>
    </div>

    <div class="card">
      <h3>Active Warranties</h3>
      <span id="activeWarranty">0</span>
    </div>

    <div class="card">
      <h3>Warranty Claims</h3>
      <span id="totalClaims">0</span>
    </div>

  </section>

  <!-- QUICK ACTIONS -->
  <section class="dealer-actions">
    <a href="/public/dealer/activate-warranty.html" class="btn-primary">
      Activate Warranty
    </a>

    <a href="/public/dealer/sold-batteries.html" class="btn-secondary">
      Sold Batteries
    </a>

    <a href="/public/dealer/claims.html" class="btn-secondary">
      Warranty Claims
    </a>
  </section>

  <!-- RECENT ACTIVATIONS -->
  <section class="dealer-list">
    <h2>Recent Warranty Activations</h2>
    <ul id="recentList"></ul>
  </section>

</main>

<!-- ================= FOOTER ================= -->
<footer class="dealer-footer">
  <p>Â© <span id="year"></span> Ionvex Energy Solutions</p>
</footer>

<!-- ================= JS ================= -->
<script type="module">
  import { auth, logout } from "/js/firebase/auth.js";
  import { db } from "/js/firebase/firestore.js";
  import {
    collection,
    query,
    where,
    orderBy,
    limit,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  document.getElementById("year").textContent = new Date().getFullYear();

  document.getElementById("logoutBtn").onclick = () => logout();

  async function loadDashboard() {
    const user = auth.currentUser;
    if (!user) return;

    const q = query(
      collection(db, "batteries"),
      where("activatedBy", "==", user.uid)
    );

    const snap = await getDocs(q);

    let total = 0;
    let active = 0;

    snap.forEach(doc => {
      total++;
      if (doc.data().status === "ACTIVE") active++;
    });

    document.getElementById("totalActivated").textContent = total;
    document.getElementById("activeWarranty").textContent = active;

    const recentQ = query(
      collection(db, "batteries"),
      where("activatedBy", "==", user.uid),
      orderBy("activatedAt", "desc"),
      limit(5)
    );

    const recentSnap = await getDocs(recentQ);
    const list = document.getElementById("recentList");
    list.innerHTML = "";

    recentSnap.forEach(doc => {
      const li = document.createElement("li");
      li.textContent = `${doc.id} | ${doc.data().customerName}`;
      list.appendChild(li);
    });
  }

  loadDashboard();
</script>

</body>
  </html>
