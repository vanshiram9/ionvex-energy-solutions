<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Activate Warranty | Dealer Panel</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/dealer.css" />
</head>
<body>

<!-- üîê AUTH + ROLE GUARD -->
<script type="module">
  import { auth } from "/js/firebase/auth.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getUserRole } from "/js/firebase/role.js";

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/public/login.html";
      return;
    }

    const role = await getUserRole(user.uid);
    if (role !== "DEALER") {
      window.location.href = "/public/login.html";
    }
  });
</script>

<!-- ================= HEADER ================= -->
<header class="dealer-header">
  <h2>Activate Warranty</h2>
  <a href="/public/dealer/dashboard.html" class="btn-outline">‚Üê Back</a>
</header>

<!-- ================= MAIN ================= -->
<main class="dealer-main">

  <h1>Battery Warranty Activation</h1>

  <form id="activationForm" class="dealer-form">

    <label>Battery Serial Number</label>
    <input type="text" id="serial" required placeholder="Enter Battery Serial No" />

    <label>Customer Name</label>
    <input type="text" id="customerName" required />

    <label>Customer Phone</label>
    <input type="tel" id="customerPhone" required />

    <label>Vehicle Type</label>
    <select id="vehicleType" required>
      <option value="">Select</option>
      <option value="2W">2 Wheeler</option>
      <option value="3W">3 Wheeler</option>
      <option value="4W">4 Wheeler</option>
    </select>

    <label>Warranty Duration</label>
    <select id="warrantyMonths" required>
      <option value="24">24 Months</option>
      <option value="36">36 Months</option>
      <option value="48">48 Months</option>
    </select>

    <button type="submit" class="btn-primary">
      Activate Warranty
    </button>

  </form>

  <div id="resultBox" class="result-box"></div>

</main>

<!-- ================= JS ================= -->
<script type="module">
  import { auth } from "/js/firebase/auth.js";
  import { db } from "/js/firebase/firestore.js";
  import {
    doc,
    getDoc,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const form = document.getElementById("activationForm");
  const resultBox = document.getElementById("resultBox");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    resultBox.textContent = "Processing...";

    const serial = document.getElementById("serial").value.trim();
    const customerName = document.getElementById("customerName").value;
    const customerPhone = document.getElementById("customerPhone").value;
    const vehicleType = document.getElementById("vehicleType").value;
    const months = parseInt(document.getElementById("warrantyMonths").value);

    try {
      const ref = doc(db, "batteries", serial);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        resultBox.textContent = "‚ùå Invalid Serial Number";
        return;
      }

      if (snap.data().status === "ACTIVE") {
        resultBox.textContent = "‚ö†Ô∏è Warranty already activated";
        return;
      }

      const expiry = new Date();
      expiry.setMonth(expiry.getMonth() + months);

      await updateDoc(ref, {
        customerName,
        customerPhone,
        vehicleType,
        activatedBy: auth.currentUser.uid,
        activatedAt: serverTimestamp(),
        warrantyExpiry: expiry,
        status: "ACTIVE"
      });

      resultBox.textContent = "‚úÖ Warranty Activated Successfully";
      form.reset();

    } catch (err) {
      resultBox.textContent = "‚ùå Error: " + err.message;
    }
  });
</script>

</body>
</html>
