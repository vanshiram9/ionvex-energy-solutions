<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Raise Warranty Claim | Ionvex Energy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/customer.css" />
</head>
<body>

<header class="customer-header">
  <img src="/assets/images/logo.png" class="logo" />
  <h2>Warranty Claim Request</h2>
</header>

<main class="customer-main">

  <form id="claimForm" class="card">

    <h3>Battery Details</h3>

    <div class="field">
      <label>Serial Number</label>
      <input id="serialInput" readonly />
    </div>

    <div class="field">
      <label>Problem Type</label>
      <select id="problemType" required>
        <option value="">Select</option>
        <option>Battery Not Charging</option>
        <option>Low Backup</option>
        <option>BMS Issue</option>
        <option>Physical Damage</option>
        <option>Other</option>
      </select>
    </div>

    <div class="field">
      <label>Description</label>
      <textarea id="description" placeholder="Explain the issue..." required></textarea>
    </div>

    <div class="field">
      <label>Upload Image (optional)</label>
      <input type="file" id="photo" accept="image/*" />
    </div>

    <button type="submit" class="btn primary">
      Submit Claim
    </button>

  </form>

</main>

<footer class="customer-footer">
  <p>¬© <span id="year"></span> Ionvex Energy Solutions</p>
</footer>

<!-- ================= JS ================= -->
<script type="module">
  import { db } from "/js/firebase/firestore.js";
  import { storage } from "/js/firebase/storage.js";

  import {
    addDoc,
    collection,
    serverTimestamp,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import {
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  document.getElementById("year").innerText = new Date().getFullYear();

  // üîó SERIAL FROM URL
  const params = new URLSearchParams(window.location.search);
  const serial = params.get("serial");

  if (!serial) {
    alert("Invalid access");
    location.href = "/public/customer/warranty.html";
  }

  document.getElementById("serialInput").value = serial;

  // üì® SUBMIT CLAIM
  document.getElementById("claimForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const type = problemType.value;
    const desc = description.value;
    const file = photo.files[0];

    if (!type || !desc) {
      alert("Fill all required fields");
      return;
    }

    // üîç VERIFY BATTERY
    const batterySnap = await getDoc(doc(db, "batteries", serial));
    if (!batterySnap.exists() || batterySnap.data().status !== "ACTIVE") {
      alert("Warranty not active");
      return;
    }

    let imageUrl = "";

    // üì§ UPLOAD IMAGE
    if (file) {
      const imgRef = ref(storage, `claims/${serial}_${Date.now()}`);
      await uploadBytes(imgRef, file);
      imageUrl = await getDownloadURL(imgRef);
    }

    // üìù SAVE CLAIM
    await addDoc(collection(db, "claims"), {
      serial,
      problemType: type,
      description: desc,
      imageUrl,
      status: "PENDING",
      createdAt: serverTimestamp(),
      source: "CUSTOMER"
    });

    alert("Claim submitted successfully!");
    location.href = "/public/customer/warranty.html";
  });
</script>

</body>
</html>
