<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Raise Warranty Claim | Ionvex Energy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/customer.css" />
</head>
<body>

<header class="customer-header">
  <img src="/assets/images/logo.png" class="logo" alt="Ionvex Energy" />
  <h2>Raise Warranty Claim</h2>
</header>

<main class="customer-main">

  <form id="claimForm" class="card form-card">
    <h3>Battery Claim Form</h3>

    <div class="form-group">
      <label>Battery Serial Number</label>
      <input type="text" id="serial" readonly />
    </div>

    <div class="form-group">
      <label>Issue Type</label>
      <select id="issueType" required>
        <option value="">Select Issue</option>
        <option value="not_charging">Not Charging</option>
        <option value="low_backup">Low Backup</option>
        <option value="heating">Over Heating</option>
        <option value="physical_damage">Physical Damage</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="form-group">
      <label>Issue Description</label>
      <textarea id="description" rows="4" placeholder="Describe the problem..." required></textarea>
    </div>

    <div class="form-group">
      <label>Upload Battery Image (optional)</label>
      <input type="file" id="image" accept="image/*" />
    </div>

    <button type="submit" class="primary-btn">Submit Claim</button>
  </form>

</main>

<footer class="customer-footer">
  <p>© <span id="year"></span> Ionvex Energy Solutions</p>
</footer>

<!-- ================= JS ================= -->
<script type="module">
  import { db } from "/js/firebase/firestore.js";
  import { uploadImage } from "/js/firebase/storage.js";
  import {
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  document.getElementById("year").innerText = new Date().getFullYear();

  const params = new URLSearchParams(window.location.search);
  const serialParam = params.get("serial");

  if (!serialParam) {
    alert("Invalid access");
    window.location.href = "/public/index.html";
  }

  document.getElementById("serial").value = serialParam;

  const form = document.getElementById("claimForm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const issueType = document.getElementById("issueType").value;
    const description = document.getElementById("description").value.trim();
    const imageFile = document.getElementById("image").files[0];

    if (!issueType || !description) {
      alert("Please fill all required fields");
      return;
    }

    let imageUrl = "";

    try {
      if (imageFile) {
        imageUrl = await uploadImage(
          imageFile,
          `claims/${serialParam}_${Date.now()}`
        );
      }

      await addDoc(collection(db, "claims"), {
        serial: serialParam,
        issueType,
        description,
        imageUrl,
        status: "pending",
        createdAt: serverTimestamp(),
        source: "customer"
      });

      alert("Claim submitted successfully ✅");
      window.location.href = `/public/customer/track-claim.html?serial=${serialParam}`;

    } catch (err) {
      console.error(err);
      alert("Something went wrong. Try again.");
    }
  });
</script>

</body>
</html>
